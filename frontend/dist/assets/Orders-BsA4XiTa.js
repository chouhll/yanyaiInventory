const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Dx6wz3Hl.js","assets/index-uDybftPD.css"])))=>i.map(i=>d[i]);
import{_ as Ae,r as C,o as Ve,d as P,e as s,h as t,w as l,i as r,H as N,E as p,y as Te,I as Ue,v as Ne,j as v,m as u,s as Oe,x as k,f as A,t as m,F as L,B as $,C as B,J as Z}from"./index-Dx6wz3Hl.js";const ze={class:"orders-page"},Se={class:"page-header"},Le={class:"customer-info"},$e={class:"order-items"},qe={class:"item-name"},Fe={class:"item-detail"},Re={key:0,class:"more-items"},Be={class:"amount-cell"},Me={class:"amount-value"},He={class:"date-info"},We={class:"action-buttons"},je={style:{float:"right",color:"#8492a6","font-size":"13px"}},Ge={class:"items-container"},Ke={class:"item-form-header"},Je={class:"item-number"},Qe={class:"product-option"},Xe={class:"product-name"},Ye={class:"product-info"},Ze={class:"product-price"},et={class:"item-subtotal"},tt={class:"subtotal-value"},lt={class:"order-total"},at={class:"total-value"},nt={class:"dialog-footer"},ot={class:"dialog-footer"},st={__name:"Orders",setup(rt){const q=C([]),O=C([]),M=C([]),z=C(!1),V=C(!1),T=C(!1),g=C(!1),S=C(null),U=C(""),y=C({customerId:null,items:[{productId:null,quantity:1,unitPrice:0,costUnitPrice:0}]}),h=async()=>{z.value=!0;try{q.value=await N.getAll()}catch{p.error("加载订单列表失败")}finally{z.value=!1}},ee=async()=>{try{O.value=await Te.getAll()}catch{p.error("加载产品列表失败")}},te=async()=>{try{M.value=await Ue.getAll()}catch{p.error("加载客户列表失败")}},le=a=>!a||a.length===0?0:a.reduce((e,d)=>e+(d.subtotal||0),0),ae=()=>y.value.items.reduce((a,e)=>a+(e.quantity||0)*(e.unitPrice||0),0),ne=()=>{y.value.items.push({productId:null,quantity:1,unitPrice:0,costUnitPrice:0})},oe=a=>{y.value.items.splice(a,1)},se=(a,e)=>{const d=O.value.find(o=>o.id===a.productId);d&&(a.unitPrice=d.price||0,a.costUnitPrice=d.price||0)},re=async()=>{var e,d;if(!y.value.customerId){p.warning("请选择客户");return}if(y.value.items.some(o=>!o.productId||o.quantity<=0)){p.warning("请完整填写所有订单项");return}g.value=!0;try{const o={customer:{id:y.value.customerId},orderDate:new Date().toISOString(),items:y.value.items.map(i=>{const _=O.value.find(w=>w.id===i.productId);return{product:{id:i.productId},quantity:i.quantity,unitPrice:i.unitPrice||(_==null?void 0:_.price)||0,costUnitPrice:i.costUnitPrice||(_==null?void 0:_.price)||0,subtotal:i.quantity*(i.unitPrice||(_==null?void 0:_.price)||0),costSubtotal:i.quantity*(i.costUnitPrice||(_==null?void 0:_.price)||0)}})};await N.create(o),p.success("订单创建成功"),V.value=!1,y.value={customerId:null,items:[{productId:null,quantity:1,unitPrice:0,costUnitPrice:0}]},h()}catch(o){p.error("创建失败: "+(((d=(e=o.response)==null?void 0:e.data)==null?void 0:d.message)||o.message))}finally{g.value=!1}},ie=a=>{S.value=a,U.value=a.status,T.value=!0},de=async()=>{if(!U.value){p.warning("请选择新状态");return}g.value=!0;try{await N.updateStatus(S.value.id,U.value),p.success("状态更新成功"),T.value=!1,h()}catch{p.error("状态更新失败")}finally{g.value=!1}},ue=async a=>{try{await B.confirm(`确定要删除订单 ${a.orderNumber||"#"+a.id} 吗？此操作不可撤销。`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}),await N.delete(a.id),p.success("订单删除成功"),h()}catch(e){e!=="cancel"&&p.error("删除失败")}},ce=a=>{if(!a)return"-";const e=new Date(a);return`${e.getMonth()+1}/${e.getDate()} ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}`},H=a=>({CREATED:"info",CONTRACT_DRAFT:"warning",UNPAID:"warning",PAID:"success",PENDING_STOCK:"warning",INVOICED:"primary",SHIPPED:"",COMPLETED:"success",CANCELLED:"danger"})[a]||"info",W=a=>({CREATED:"已创建",CONTRACT_DRAFT:"合同拟定",UNPAID:"未付款",PAID:"已付款",PENDING_STOCK:"待备货",INVOICED:"已开票",SHIPPED:"已发货",COMPLETED:"已完成",CANCELLED:"已取消"})[a]||a,pe=a=>["CONTRACT_DRAFT","UNPAID","PAID","INVOICED","SHIPPED","COMPLETED"].includes(a.status),me=a=>["PAID","INVOICED","PENDING_STOCK"].includes(a.status),_e=async a=>{var e,d;try{await B.confirm(`确定要将订单 ${a.orderNumber||"#"+a.id} 标记为已发货吗？
系统将验证库存并扣减相应数量。`,"出库确认",{confirmButtonText:"确认出库",cancelButtonText:"取消",type:"warning"}),g.value=!0,await N.shipOrder(a.id),p.success("订单已成功出库！库存已扣减。"),h()}catch(o){if(o!=="cancel"){const i=((d=(e=o.response)==null?void 0:e.data)==null?void 0:d.message)||o.message||"出库失败";p.error({message:i,duration:5e3,showClose:!0})}}finally{g.value=!1}},fe=async a=>{try{B.alert(`<div style="text-align: center;">
        <p style="font-size: 16px; margin-bottom: 20px;">请选择合同操作</p>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button id="download-word" style="padding: 10px 20px; background: #67C23A; color: white; border: none; border-radius: 4px; cursor: pointer;">
            下载 Word
          </button>
          <button id="download-pdf" style="padding: 10px 20px; background: #E6A23C; color: white; border: none; border-radius: 4px; cursor: pointer;">
            下载 PDF
          </button>
          <button id="confirm-contract" style="padding: 10px 20px; background: #409EFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
            确认合同
          </button>
        </div>
      </div>`,`订单合同 - ${a.orderNumber||"#"+a.id}`,{dangerouslyUseHTMLString:!0,confirmButtonText:"关闭",callback:()=>{}}),setTimeout(()=>{var e,d,o;(e=document.getElementById("download-word"))==null||e.addEventListener("click",()=>j(a.id,"word")),(d=document.getElementById("download-pdf"))==null||d.addEventListener("click",()=>j(a.id,"pdf")),(o=document.getElementById("confirm-contract"))==null||o.addEventListener("click",()=>ve(a.id))},100)}catch(e){console.error("合同操作失败:",e)}},j=async(a,e)=>{try{const{contractApi:d}=await Z(async()=>{const{contractApi:D}=await import("./index-Dx6wz3Hl.js").then(F=>F.W);return{contractApi:D}},__vite__mapDeps([0,1]));let o;e==="word"?o=await d.downloadWord(a):o=await d.downloadPdf(a);const i=await o.blob(),_=window.URL.createObjectURL(i),w=document.createElement("a");w.href=_,w.download=`contract_${a}.${e==="word"?"docx":"pdf"}`,document.body.appendChild(w),w.click(),document.body.removeChild(w),window.URL.revokeObjectURL(_),p.success(`合同${e==="word"?"Word":"PDF"}下载成功`)}catch(d){p.error("下载失败: "+(d.message||"未知错误"))}},ve=async a=>{try{const{contractApi:e}=await Z(async()=>{const{contractApi:d}=await import("./index-Dx6wz3Hl.js").then(o=>o.W);return{contractApi:d}},__vite__mapDeps([0,1]));await e.confirm(a),p.success("合同已确认"),h()}catch(e){p.error("确认失败: "+(e.message||"未知错误"))}};return Ve(()=>{h(),ee(),te()}),(a,e)=>{const d=r("Plus"),o=r("el-icon"),i=r("el-button"),_=r("DocumentCopy"),w=r("el-link"),D=r("el-table-column"),F=r("User"),ye=r("Calendar"),b=r("el-tag"),ge=r("Document"),be=r("Sell"),Ce=r("el-table"),we=r("el-empty"),De=r("el-card"),I=r("el-option"),R=r("el-select"),x=r("el-form-item"),Ie=r("List"),Pe=r("el-divider"),ke=r("Delete"),G=r("el-input-number"),K=r("el-col"),Ee=r("el-row"),J=r("el-form"),he=r("Check"),Q=r("el-dialog"),xe=Ne("loading");return v(),P("div",ze,[s("div",Se,[e[8]||(e[8]=s("div",{class:"header-content"},[s("h2",{class:"page-title"},"订单管理"),s("p",{class:"page-subtitle"},"管理和跟踪所有订单")],-1)),t(i,{type:"primary",size:"large",onClick:e[0]||(e[0]=n=>V.value=!0)},{default:l(()=>[t(o,null,{default:l(()=>[t(d)]),_:1}),e[7]||(e[7]=u(" 创建订单 ",-1))]),_:1})]),t(De,{shadow:"hover",class:"main-card"},{default:l(()=>[Oe((v(),k(Ce,{data:q.value,stripe:"","header-cell-style":{background:"#f5f7fa",color:"#606266",fontWeight:"600"}},{default:l(()=>[t(D,{label:"订单号",width:"160",fixed:"left"},{default:l(({row:n})=>[t(w,{type:"primary",onClick:c=>a.$router.push(`/orders/${n.id}`),underline:!1,class:"order-link"},{default:l(()=>[t(o,null,{default:l(()=>[t(_)]),_:1}),u(" "+m(n.orderNumber||`#${n.id}`),1)]),_:2},1032,["onClick"])]),_:1}),t(D,{label:"客户",width:"150"},{default:l(({row:n})=>{var c;return[s("div",Le,[t(o,{class:"info-icon"},{default:l(()=>[t(F)]),_:1}),s("span",null,m(((c=n.customer)==null?void 0:c.name)||"-"),1)])]}),_:1}),t(D,{label:"订单明细","min-width":"280"},{default:l(({row:n})=>{var c,f;return[s("div",$e,[(v(!0),P(L,null,$((c=n.items)==null?void 0:c.slice(0,2),(E,it)=>{var X,Y;return v(),P("div",{key:E.id,class:"item-row"},[s("span",qe,m((X=E.product)==null?void 0:X.name),1),s("span",Fe," × "+m(E.quantity)+" | ¥"+m((Y=E.unitPrice)==null?void 0:Y.toFixed(2)),1)])}),128)),((f=n.items)==null?void 0:f.length)>2?(v(),P("div",Re," +"+m(n.items.length-2)+" 更多商品 ",1)):A("",!0)])]}),_:1}),t(D,{label:"订单金额",width:"130",align:"right"},{default:l(({row:n})=>[s("div",Be,[s("span",Me,"¥"+m(le(n.items).toFixed(2)),1)])]),_:1}),t(D,{label:"订单日期",width:"160"},{default:l(({row:n})=>[s("div",He,[t(o,{class:"info-icon"},{default:l(()=>[t(ye)]),_:1}),s("span",null,m(ce(n.orderDate)),1)])]),_:1}),t(D,{label:"状态",width:"110",align:"center"},{default:l(({row:n})=>[t(b,{type:H(n.status),effect:"dark",size:"default"},{default:l(()=>[u(m(W(n.status)),1)]),_:2},1032,["type"])]),_:1}),t(D,{label:"操作",width:"300",fixed:"right",align:"center"},{default:l(({row:n})=>[s("div",We,[pe(n)?(v(),k(i,{key:0,type:"warning",size:"small",onClick:c=>fe(n)},{default:l(()=>[t(o,null,{default:l(()=>[t(ge)]),_:1}),e[9]||(e[9]=u(" 合同 ",-1))]),_:1},8,["onClick"])):A("",!0),me(n)?(v(),k(i,{key:1,type:"success",size:"small",onClick:c=>_e(n),loading:g.value},{default:l(()=>[t(o,null,{default:l(()=>[t(be)]),_:1}),e[10]||(e[10]=u(" 出库 ",-1))]),_:1},8,["onClick","loading"])):A("",!0),t(i,{type:"primary",size:"small",onClick:c=>ie(n),plain:""},{default:l(()=>[...e[11]||(e[11]=[u(" 状态 ",-1)])]),_:1},8,["onClick"]),t(i,{type:"danger",size:"small",onClick:c=>ue(n),plain:""},{default:l(()=>[...e[12]||(e[12]=[u(" 删除 ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),[[xe,z.value]]),!z.value&&q.value.length===0?(v(),k(we,{key:0,description:"暂无订单数据","image-size":120})):A("",!0)]),_:1}),t(Q,{modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=n=>V.value=n),title:"创建新订单",width:"750px","close-on-click-modal":!1},{footer:l(()=>[s("div",nt,[t(i,{onClick:e[2]||(e[2]=n=>V.value=!1),size:"large"},{default:l(()=>[...e[18]||(e[18]=[u("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:re,loading:g.value,size:"large"},{default:l(()=>[g.value?A("",!0):(v(),k(o,{key:0},{default:l(()=>[t(he)]),_:1})),e[19]||(e[19]=u(" 确认创建 ",-1))]),_:1},8,["loading"])])]),default:l(()=>[t(J,{model:y.value,"label-width":"90px",class:"order-form"},{default:l(()=>[t(x,{label:"选择客户",required:""},{default:l(()=>[t(R,{modelValue:y.value.customerId,"onUpdate:modelValue":e[1]||(e[1]=n=>y.value.customerId=n),placeholder:"请选择客户",size:"large",filterable:"",style:{width:"100%"}},{default:l(()=>[(v(!0),P(L,null,$(M.value,n=>(v(),k(I,{key:n.id,label:n.name,value:n.id},{default:l(()=>[s("span",null,m(n.name),1),s("span",je,m(n.phone||"-"),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(Pe,{"content-position":"left"},{default:l(()=>[t(o,null,{default:l(()=>[t(Ie)]),_:1}),e[13]||(e[13]=u(" 订单商品 ",-1))]),_:1}),s("div",Ge,[(v(!0),P(L,null,$(y.value.items,(n,c)=>(v(),P("div",{key:c,class:"item-form-card"},[s("div",Ke,[s("span",Je,"商品 "+m(c+1),1),y.value.items.length>1?(v(),k(i,{key:0,type:"danger",size:"small",text:"",onClick:f=>oe(c)},{default:l(()=>[t(o,null,{default:l(()=>[t(ke)]),_:1}),e[14]||(e[14]=u(" 移除 ",-1))]),_:1},8,["onClick"])):A("",!0)]),t(x,{label:"选择产品",required:""},{default:l(()=>[t(R,{modelValue:n.productId,"onUpdate:modelValue":f=>n.productId=f,placeholder:"搜索并选择产品",filterable:"",style:{width:"100%"},onChange:f=>se(n,c)},{default:l(()=>[(v(!0),P(L,null,$(O.value,f=>(v(),k(I,{key:f.id,label:f.name,value:f.id},{default:l(()=>{var E;return[s("div",Qe,[s("span",Xe,m(f.name),1),s("span",Ye,[t(b,{size:"small",type:"info"},{default:l(()=>[u("库存: "+m(f.stock||0),1)]),_:2},1024),s("span",Ze,"¥"+m((E=f.price)==null?void 0:E.toFixed(2)),1)])])]}),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024),t(Ee,{gutter:20},{default:l(()=>[t(K,{span:12},{default:l(()=>[t(x,{label:"数量",required:""},{default:l(()=>[t(G,{modelValue:n.quantity,"onUpdate:modelValue":f=>n.quantity=f,min:.01,precision:2,step:1,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),t(K,{span:12},{default:l(()=>[t(x,{label:"单价",required:""},{default:l(()=>[t(G,{modelValue:n.unitPrice,"onUpdate:modelValue":f=>n.unitPrice=f,precision:2,min:0,step:.01,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),s("div",et,[e[15]||(e[15]=s("span",{class:"subtotal-label"},"小计:",-1)),s("span",tt,"¥"+m(((n.quantity||0)*(n.unitPrice||0)).toFixed(2)),1)])]))),128))]),t(i,{type:"primary",plain:"",onClick:ne,class:"add-item-btn",size:"large"},{default:l(()=>[t(o,null,{default:l(()=>[t(d)]),_:1}),e[16]||(e[16]=u(" 添加更多商品 ",-1))]),_:1}),s("div",lt,[e[17]||(e[17]=s("span",{class:"total-label"},"订单总额:",-1)),s("span",at,"¥"+m(ae().toFixed(2)),1)])]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Q,{modelValue:T.value,"onUpdate:modelValue":e[6]||(e[6]=n=>T.value=n),title:"更新订单状态",width:"450px","close-on-click-modal":!1},{footer:l(()=>[s("div",ot,[t(i,{onClick:e[5]||(e[5]=n=>T.value=!1),size:"large"},{default:l(()=>[...e[27]||(e[27]=[u("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:de,loading:g.value,size:"large"},{default:l(()=>[...e[28]||(e[28]=[u(" 确认更新 ",-1)])]),_:1},8,["loading"])])]),default:l(()=>[t(J,{"label-width":"90px"},{default:l(()=>[t(x,{label:"当前状态"},{default:l(()=>{var n;return[t(b,{type:H((n=S.value)==null?void 0:n.status),size:"large",effect:"dark"},{default:l(()=>{var c;return[u(m(W((c=S.value)==null?void 0:c.status)),1)]}),_:1},8,["type"])]}),_:1}),t(x,{label:"新状态",required:""},{default:l(()=>[t(R,{modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=n=>U.value=n),placeholder:"请选择新状态",size:"large",style:{width:"100%"}},{default:l(()=>[t(I,{label:"已创建",value:"CREATED"},{default:l(()=>[t(b,{type:"info",size:"small"},{default:l(()=>[...e[20]||(e[20]=[u("已创建",-1)])]),_:1})]),_:1}),t(I,{label:"未付款",value:"UNPAID"},{default:l(()=>[t(b,{type:"warning",size:"small"},{default:l(()=>[...e[21]||(e[21]=[u("未付款",-1)])]),_:1})]),_:1}),t(I,{label:"付款完成",value:"PAID"},{default:l(()=>[t(b,{type:"success",size:"small"},{default:l(()=>[...e[22]||(e[22]=[u("付款完成",-1)])]),_:1})]),_:1}),t(I,{label:"已开票",value:"INVOICED"},{default:l(()=>[t(b,{type:"primary",size:"small"},{default:l(()=>[...e[23]||(e[23]=[u("已开票",-1)])]),_:1})]),_:1}),t(I,{label:"已发货",value:"SHIPPED"},{default:l(()=>[t(b,{size:"small"},{default:l(()=>[...e[24]||(e[24]=[u("已发货",-1)])]),_:1})]),_:1}),t(I,{label:"已完成",value:"COMPLETED"},{default:l(()=>[t(b,{type:"success",size:"small"},{default:l(()=>[...e[25]||(e[25]=[u("已完成",-1)])]),_:1})]),_:1}),t(I,{label:"已取消",value:"CANCELLED"},{default:l(()=>[t(b,{type:"danger",size:"small"},{default:l(()=>[...e[26]||(e[26]=[u("已取消",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},ut=Ae(st,[["__scopeId","data-v-e2335ca6"]]);export{ut as default};
