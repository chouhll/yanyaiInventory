const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CV1_q4ff.js","assets/index-uDybftPD.css"])))=>i.map(i=>d[i]);
import{_ as Ue,r as D,o as xe,d as A,e as s,h as t,w as l,i as d,H as O,E as _,y as ze,I as Se,v as Re,j as v,m as i,s as $e,x as I,f as E,t as p,F as $,B as L,C as oe,J as se}from"./index-CV1_q4ff.js";const Le={class:"orders-page"},qe={class:"page-header"},Fe={class:"customer-info"},Be={class:"order-items"},Me={class:"item-name"},He={class:"item-detail"},We={key:0,class:"more-items"},je={class:"amount-cell"},Ge={class:"amount-value"},Ke={class:"date-info"},Je={class:"action-buttons"},Qe={style:{float:"right",color:"#8492a6","font-size":"13px"}},Xe={class:"items-container"},Ye={class:"item-form-header"},Ze={class:"item-number"},et={class:"product-option"},tt={class:"product-name"},lt={class:"product-info"},at={class:"product-price"},nt={class:"item-subtotal"},ot={class:"subtotal-value"},st={class:"order-total"},dt={class:"total-value"},it={class:"dialog-footer"},rt={class:"dialog-footer"},ut={__name:"Orders",setup(ct){const q=D([]),U=D([]),H=D([]),x=D(!1),h=D(!1),z=D(!1),w=D(!1),F=D(null),S=D(""),y=D({customerId:null,items:[{productId:null,quantity:1,unitPrice:0,costUnitPrice:0}]}),T=async()=>{x.value=!0;try{q.value=await O.getAll()}catch{_.error("加载订单列表失败")}finally{x.value=!1}},de=async()=>{try{U.value=await ze.getAll()}catch{_.error("加载产品列表失败")}},ie=async()=>{try{H.value=await Se.getAll()}catch{_.error("加载客户列表失败")}},re=n=>!n||n.length===0?0:n.reduce((e,u)=>e+(u.subtotal||0),0),ue=()=>y.value.items.reduce((n,e)=>n+(e.quantity||0)*(e.unitPrice||0),0),ce=()=>{y.value.items.push({productId:null,quantity:1,unitPrice:0,costUnitPrice:0})},_e=n=>{y.value.items.splice(n,1)},pe=(n,e)=>{const u=U.value.find(o=>o.id===n.productId);u&&(n.unitPrice=u.price||0,n.costUnitPrice=u.price||0)},me=async()=>{var e,u;if(!y.value.customerId){_.warning("请选择客户");return}if(y.value.items.some(o=>!o.productId||o.quantity<=0)){_.warning("请完整填写所有订单项");return}w.value=!0;try{const o={customer:{id:y.value.customerId},orderDate:new Date().toISOString(),items:y.value.items.map(r=>{const m=U.value.find(b=>b.id===r.productId);return{product:{id:r.productId},quantity:r.quantity,unitPrice:r.unitPrice||(m==null?void 0:m.price)||0,costUnitPrice:r.costUnitPrice||(m==null?void 0:m.price)||0,subtotal:r.quantity*(r.unitPrice||(m==null?void 0:m.price)||0),costSubtotal:r.quantity*(r.costUnitPrice||(m==null?void 0:m.price)||0)}})};await O.create(o),_.success("订单创建成功"),h.value=!1,y.value={customerId:null,items:[{productId:null,quantity:1,unitPrice:0,costUnitPrice:0}]},T()}catch(o){_.error("创建失败: "+(((u=(e=o.response)==null?void 0:e.data)==null?void 0:u.message)||o.message))}finally{w.value=!1}},fe=async()=>{if(!S.value){_.warning("请选择新状态");return}w.value=!0;try{await O.updateStatus(F.value.id,S.value),_.success("状态更新成功"),z.value=!1,T()}catch{_.error("状态更新失败")}finally{w.value=!1}},ve=async n=>{try{await oe.confirm(`确定要删除订单 ${n.orderNumber||"#"+n.id} 吗？此操作不可撤销。`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}),await O.delete(n.id),_.success("订单删除成功"),T()}catch(e){e!=="cancel"&&_.error("删除失败")}},ye=n=>{if(!n)return"-";const e=new Date(n);return`${e.getMonth()+1}/${e.getDate()} ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}`},W=n=>({CREATED:"info",CONTRACT_DRAFT:"warning",UNPAID:"warning",PAID:"success",PENDING_STOCK:"warning",INVOICED:"primary",SHIPPED:"",COMPLETED:"success",CANCELLED:"danger"})[n]||"info",j=n=>({CREATED:"已创建",CONTRACT_DRAFT:"合同拟定",UNPAID:"未付款",PAID:"已付款",PENDING_STOCK:"待备货",INVOICED:"已开票",SHIPPED:"已发货",COMPLETED:"已完成",CANCELLED:"已取消"})[n]||n,ge=n=>["CONTRACT_DRAFT","UNPAID","PAID","INVOICED","SHIPPED","COMPLETED"].includes(n.status),we=n=>["PAID","INVOICED","PENDING_STOCK"].includes(n.status),Ce=async n=>{var e,u;try{await oe.confirm(`确定要将订单 ${n.orderNumber||"#"+n.id} 标记为已发货吗？
系统将验证库存并扣减相应数量。`,"出库确认",{confirmButtonText:"确认出库",cancelButtonText:"取消",type:"warning"}),w.value=!0,await O.shipOrder(n.id),_.success("订单已成功出库！库存已扣减。"),T()}catch(o){if(o!=="cancel"){const r=((u=(e=o.response)==null?void 0:e.data)==null?void 0:u.message)||o.message||"出库失败";_.error({message:r,duration:5e3,showClose:!0})}}finally{w.value=!1}},G=async(n,e)=>{e==="word"?await K(n.id,"word"):e==="pdf"?await K(n.id,"pdf"):e==="confirm"&&await De(n.id)},K=async(n,e)=>{try{const{contractApi:u}=await se(async()=>{const{contractApi:P}=await import("./index-CV1_q4ff.js").then(B=>B.V);return{contractApi:P}},__vite__mapDeps([0,1]));let o;e==="word"?o=await u.downloadWord(n):o=await u.downloadPdf(n);const r=await o.blob(),m=window.URL.createObjectURL(r),b=document.createElement("a");b.href=m,b.download=`contract_${n}.${e==="word"?"docx":"pdf"}`,document.body.appendChild(b),b.click(),document.body.removeChild(b),window.URL.revokeObjectURL(m),_.success(`合同${e==="word"?"Word":"PDF"}下载成功`)}catch(u){_.error("下载失败: "+(u.message||"未知错误"))}},De=async n=>{try{const{contractApi:e}=await se(async()=>{const{contractApi:u}=await import("./index-CV1_q4ff.js").then(o=>o.V);return{contractApi:u}},__vite__mapDeps([0,1]));await e.confirm(n),_.success("合同已确认"),T()}catch(e){_.error("确认失败: "+(e.message||"未知错误"))}};return xe(()=>{T(),de(),ie()}),(n,e)=>{const u=d("Plus"),o=d("el-icon"),r=d("el-button"),m=d("DocumentCopy"),b=d("el-link"),P=d("el-table-column"),B=d("User"),be=d("Calendar"),g=d("el-tag"),J=d("Document"),Pe=d("arrow-down"),R=d("Download"),N=d("el-dropdown-item"),Q=d("Check"),X=d("el-dropdown-menu"),Y=d("el-dropdown"),Ie=d("Sell"),Ae=d("el-table"),ke=d("el-empty"),Ee=d("el-card"),C=d("el-option"),M=d("el-select"),V=d("el-form-item"),Te=d("List"),Ve=d("el-divider"),he=d("Delete"),Z=d("el-input-number"),ee=d("el-col"),Ne=d("el-row"),te=d("el-form"),le=d("el-dialog"),Oe=Re("loading");return v(),A("div",Le,[s("div",qe,[e[8]||(e[8]=s("div",{class:"header-content"},[s("h2",{class:"page-title"},"订单管理"),s("p",{class:"page-subtitle"},"管理和跟踪所有订单")],-1)),t(r,{type:"primary",size:"large",onClick:e[0]||(e[0]=a=>h.value=!0)},{default:l(()=>[t(o,null,{default:l(()=>[t(u)]),_:1}),e[7]||(e[7]=i(" 创建订单 ",-1))]),_:1})]),t(Ee,{shadow:"hover",class:"main-card"},{default:l(()=>[$e((v(),I(Ae,{data:q.value,stripe:"","header-cell-style":{background:"#f5f7fa",color:"#606266",fontWeight:"600"}},{default:l(()=>[t(P,{label:"订单号",width:"160",fixed:"left"},{default:l(({row:a})=>[t(b,{type:"primary",onClick:c=>n.$router.push(`/orders/${a.id}`),underline:!1,class:"order-link"},{default:l(()=>[t(o,null,{default:l(()=>[t(m)]),_:1}),i(" "+p(a.orderNumber||`#${a.id}`),1)]),_:2},1032,["onClick"])]),_:1}),t(P,{label:"客户",width:"150"},{default:l(({row:a})=>{var c;return[s("div",Fe,[t(o,{class:"info-icon"},{default:l(()=>[t(B)]),_:1}),s("span",null,p(((c=a.customer)==null?void 0:c.name)||"-"),1)])]}),_:1}),t(P,{label:"订单明细","min-width":"280"},{default:l(({row:a})=>{var c,f;return[s("div",Be,[(v(!0),A($,null,L((c=a.items)==null?void 0:c.slice(0,2),(k,_t)=>{var ae,ne;return v(),A("div",{key:k.id,class:"item-row"},[s("span",Me,p((ae=k.product)==null?void 0:ae.name),1),s("span",He," × "+p(k.quantity)+" | ¥"+p((ne=k.unitPrice)==null?void 0:ne.toFixed(2)),1)])}),128)),((f=a.items)==null?void 0:f.length)>2?(v(),A("div",We," +"+p(a.items.length-2)+" 更多商品 ",1)):E("",!0)])]}),_:1}),t(P,{label:"订单金额",width:"130",align:"right"},{default:l(({row:a})=>[s("div",je,[s("span",Ge,"¥"+p(re(a.items).toFixed(2)),1)])]),_:1}),t(P,{label:"订单日期",width:"160"},{default:l(({row:a})=>[s("div",Ke,[t(o,{class:"info-icon"},{default:l(()=>[t(be)]),_:1}),s("span",null,p(ye(a.orderDate)),1)])]),_:1}),t(P,{label:"状态",width:"110",align:"center"},{default:l(({row:a})=>[t(g,{type:W(a.status),effect:"dark",size:"default"},{default:l(()=>[i(p(j(a.status)),1)]),_:2},1032,["type"])]),_:1}),t(P,{label:"操作",width:"320",fixed:"right",align:"center"},{default:l(({row:a})=>[s("div",Je,[a.status==="CONTRACT_DRAFT"?(v(),I(Y,{key:0,onCommand:c=>G(a,c)},{dropdown:l(()=>[t(X,null,{default:l(()=>[t(N,{command:"word"},{default:l(()=>[t(o,null,{default:l(()=>[t(R)]),_:1}),e[10]||(e[10]=i(" 下载Word ",-1))]),_:1}),t(N,{command:"pdf"},{default:l(()=>[t(o,null,{default:l(()=>[t(R)]),_:1}),e[11]||(e[11]=i(" 下载PDF ",-1))]),_:1}),t(N,{command:"confirm",divided:""},{default:l(()=>[t(o,null,{default:l(()=>[t(Q)]),_:1}),e[12]||(e[12]=i(" 确认合同 ",-1))]),_:1})]),_:1})]),default:l(()=>[t(r,{type:"warning",size:"small"},{default:l(()=>[t(o,null,{default:l(()=>[t(J)]),_:1}),e[9]||(e[9]=i(" 合同 ",-1)),t(o,{class:"el-icon--right"},{default:l(()=>[t(Pe)]),_:1})]),_:1})]),_:1},8,["onCommand"])):E("",!0),we(a)?(v(),I(r,{key:1,type:"success",size:"small",onClick:c=>Ce(a),loading:w.value},{default:l(()=>[t(o,null,{default:l(()=>[t(Ie)]),_:1}),e[13]||(e[13]=i(" 出库 ",-1))]),_:1},8,["onClick","loading"])):E("",!0),ge(a)&&a.status!=="CONTRACT_DRAFT"?(v(),I(Y,{key:2,onCommand:c=>G(a,c)},{dropdown:l(()=>[t(X,null,{default:l(()=>[t(N,{command:"word"},{default:l(()=>[t(o,null,{default:l(()=>[t(R)]),_:1}),e[15]||(e[15]=i(" 下载Word ",-1))]),_:1}),t(N,{command:"pdf"},{default:l(()=>[t(o,null,{default:l(()=>[t(R)]),_:1}),e[16]||(e[16]=i(" 下载PDF ",-1))]),_:1})]),_:1})]),default:l(()=>[t(r,{type:"info",size:"small",plain:""},{default:l(()=>[t(o,null,{default:l(()=>[t(J)]),_:1}),e[14]||(e[14]=i(" 查看合同 ",-1))]),_:1})]),_:1},8,["onCommand"])):E("",!0),t(r,{type:"danger",size:"small",onClick:c=>ve(a),plain:""},{default:l(()=>[...e[17]||(e[17]=[i(" 删除 ",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),[[Oe,x.value]]),!x.value&&q.value.length===0?(v(),I(ke,{key:0,description:"暂无订单数据","image-size":120})):E("",!0)]),_:1}),t(le,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=a=>h.value=a),title:"创建新订单",width:"750px","close-on-click-modal":!1},{footer:l(()=>[s("div",it,[t(r,{onClick:e[2]||(e[2]=a=>h.value=!1),size:"large"},{default:l(()=>[...e[23]||(e[23]=[i("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:me,loading:w.value,size:"large"},{default:l(()=>[w.value?E("",!0):(v(),I(o,{key:0},{default:l(()=>[t(Q)]),_:1})),e[24]||(e[24]=i(" 确认创建 ",-1))]),_:1},8,["loading"])])]),default:l(()=>[t(te,{model:y.value,"label-width":"90px",class:"order-form"},{default:l(()=>[t(V,{label:"选择客户",required:""},{default:l(()=>[t(M,{modelValue:y.value.customerId,"onUpdate:modelValue":e[1]||(e[1]=a=>y.value.customerId=a),placeholder:"请选择客户",size:"large",filterable:"",style:{width:"100%"}},{default:l(()=>[(v(!0),A($,null,L(H.value,a=>(v(),I(C,{key:a.id,label:a.name,value:a.id},{default:l(()=>[s("span",null,p(a.name),1),s("span",Qe,p(a.phone||"-"),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(Ve,{"content-position":"left"},{default:l(()=>[t(o,null,{default:l(()=>[t(Te)]),_:1}),e[18]||(e[18]=i(" 订单商品 ",-1))]),_:1}),s("div",Xe,[(v(!0),A($,null,L(y.value.items,(a,c)=>(v(),A("div",{key:c,class:"item-form-card"},[s("div",Ye,[s("span",Ze,"商品 "+p(c+1),1),y.value.items.length>1?(v(),I(r,{key:0,type:"danger",size:"small",text:"",onClick:f=>_e(c)},{default:l(()=>[t(o,null,{default:l(()=>[t(he)]),_:1}),e[19]||(e[19]=i(" 移除 ",-1))]),_:1},8,["onClick"])):E("",!0)]),t(V,{label:"选择产品",required:""},{default:l(()=>[t(M,{modelValue:a.productId,"onUpdate:modelValue":f=>a.productId=f,placeholder:"搜索并选择产品",filterable:"",style:{width:"100%"},onChange:f=>pe(a,c)},{default:l(()=>[(v(!0),A($,null,L(U.value,f=>(v(),I(C,{key:f.id,label:f.name,value:f.id},{default:l(()=>{var k;return[s("div",et,[s("span",tt,p(f.name),1),s("span",lt,[t(g,{size:"small",type:"info"},{default:l(()=>[i("库存: "+p(f.stock||0),1)]),_:2},1024),s("span",at,"¥"+p((k=f.price)==null?void 0:k.toFixed(2)),1)])])]}),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024),t(Ne,{gutter:20},{default:l(()=>[t(ee,{span:12},{default:l(()=>[t(V,{label:"数量",required:""},{default:l(()=>[t(Z,{modelValue:a.quantity,"onUpdate:modelValue":f=>a.quantity=f,min:.01,precision:2,step:1,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),t(ee,{span:12},{default:l(()=>[t(V,{label:"单价",required:""},{default:l(()=>[t(Z,{modelValue:a.unitPrice,"onUpdate:modelValue":f=>a.unitPrice=f,precision:2,min:0,step:.01,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),s("div",nt,[e[20]||(e[20]=s("span",{class:"subtotal-label"},"小计:",-1)),s("span",ot,"¥"+p(((a.quantity||0)*(a.unitPrice||0)).toFixed(2)),1)])]))),128))]),t(r,{type:"primary",plain:"",onClick:ce,class:"add-item-btn",size:"large"},{default:l(()=>[t(o,null,{default:l(()=>[t(u)]),_:1}),e[21]||(e[21]=i(" 添加更多商品 ",-1))]),_:1}),s("div",st,[e[22]||(e[22]=s("span",{class:"total-label"},"订单总额:",-1)),s("span",dt,"¥"+p(ue().toFixed(2)),1)])]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(le,{modelValue:z.value,"onUpdate:modelValue":e[6]||(e[6]=a=>z.value=a),title:"更新订单状态",width:"450px","close-on-click-modal":!1},{footer:l(()=>[s("div",rt,[t(r,{onClick:e[5]||(e[5]=a=>z.value=!1),size:"large"},{default:l(()=>[...e[33]||(e[33]=[i("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:fe,loading:w.value,size:"large"},{default:l(()=>[...e[34]||(e[34]=[i(" 确认更新 ",-1)])]),_:1},8,["loading"])])]),default:l(()=>[t(te,{"label-width":"90px"},{default:l(()=>[t(V,{label:"当前状态"},{default:l(()=>{var a;return[t(g,{type:W((a=F.value)==null?void 0:a.status),size:"large",effect:"dark"},{default:l(()=>{var c;return[i(p(j((c=F.value)==null?void 0:c.status)),1)]}),_:1},8,["type"])]}),_:1}),t(V,{label:"新状态",required:""},{default:l(()=>[t(M,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=a=>S.value=a),placeholder:"请选择新状态",size:"large",style:{width:"100%"}},{default:l(()=>[t(C,{label:"已创建",value:"CREATED"},{default:l(()=>[t(g,{type:"info",size:"small"},{default:l(()=>[...e[25]||(e[25]=[i("已创建",-1)])]),_:1})]),_:1}),t(C,{label:"合同拟定",value:"CONTRACT_DRAFT"},{default:l(()=>[t(g,{type:"warning",size:"small"},{default:l(()=>[...e[26]||(e[26]=[i("合同拟定",-1)])]),_:1})]),_:1}),t(C,{label:"未付款",value:"UNPAID"},{default:l(()=>[t(g,{type:"warning",size:"small"},{default:l(()=>[...e[27]||(e[27]=[i("未付款",-1)])]),_:1})]),_:1}),t(C,{label:"付款完成",value:"PAID"},{default:l(()=>[t(g,{type:"success",size:"small"},{default:l(()=>[...e[28]||(e[28]=[i("付款完成",-1)])]),_:1})]),_:1}),t(C,{label:"已开票",value:"INVOICED"},{default:l(()=>[t(g,{type:"primary",size:"small"},{default:l(()=>[...e[29]||(e[29]=[i("已开票",-1)])]),_:1})]),_:1}),t(C,{label:"已发货",value:"SHIPPED"},{default:l(()=>[t(g,{size:"small"},{default:l(()=>[...e[30]||(e[30]=[i("已发货",-1)])]),_:1})]),_:1}),t(C,{label:"已完成",value:"COMPLETED"},{default:l(()=>[t(g,{type:"success",size:"small"},{default:l(()=>[...e[31]||(e[31]=[i("已完成",-1)])]),_:1})]),_:1}),t(C,{label:"已取消",value:"CANCELLED"},{default:l(()=>[t(g,{type:"danger",size:"small"},{default:l(()=>[...e[32]||(e[32]=[i("已取消",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},mt=Ue(ut,[["__scopeId","data-v-85ca4623"]]);export{mt as default};
